#!/bin/bash

# ================================================
# WordPress Auto-Install Script (Nginx, PHP 8.3, MariaDB, Rank Math, SEO)
# ================================================

# Mengambil Input dari Pengguna
read -p "Masukkan nama domain (contoh: example.com): " DOMAIN
read -p "Masukkan nama database: " DB_NAME
read -p "Masukkan username MySQL: " DB_USER
read -s -p "Masukkan password MySQL: " DB_PASS
echo

# Direktori Root untuk WordPress
ROOT_DIR="/var/www/$DOMAIN/wordpress"
SSL_DIR="/etc/ssl/$DOMAIN"

# Firewall Setup
echo "=== Setup UFW Firewall ==="
ufw enable
ufw allow ssh
ufw allow 'Nginx Full'

# Install Nginx, PHP 8.3, dan MariaDB
echo "=== Installing Nginx, PHP 8.3, and MariaDB ==="
sudo apt update -y
sudo apt install -y nginx php8.3-fpm php8.3-common php8.3-dom php8.3-intl php8.3-mysql php8.3-xml php8.3-xmlrpc php8.3-curl php8.3-gd php8.3-imagick php8.3-cli php8.3-dev php8.3-imap php8.3-mbstring php8.3-soap php8.3-zip php8.3-bcmath mariadb-server zip curl software-properties-common apt-transport-https

# Secure MariaDB Installation
echo "=== Secure MariaDB Installation ==="
sudo mysql_secure_installation

# Membuat Database dan User
echo "=== Creating MySQL Database and User ==="
sudo mysql -u root -p$DB_PASS <<EOF
CREATE DATABASE IF NOT EXISTS $DB_NAME;
CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';
GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';
FLUSH PRIVILEGES;
EOF

# Install WordPress
echo "=== Installing WordPress ==="
mkdir -p $ROOT_DIR
cd $ROOT_DIR
wget https://wordpress.org/latest.zip
unzip latest.zip
rm -f latest.zip

# Konfigurasi Nginx untuk WordPress
echo "=== Configuring Nginx for WordPress ==="
NGINX_CONF="/etc/nginx/sites-available/$DOMAIN"
cat > $NGINX_CONF <<EOL
server {
    listen 80;
    listen [::]:80;
    server_name www.$DOMAIN $DOMAIN;
    root $ROOT_DIR;
    index index.php index.html index.htm;

    error_log /var/log/nginx/$DOMAIN.error;
    access_log /var/log/nginx/$DOMAIN.access;

    location / {
        limit_req zone=mylimit burst=20 nodelay;
        limit_conn addr 10;
        try_files \$uri \$uri/ /index.php?\$args;

        # START Nginx Rewrites for Rank Math Sitemaps
        rewrite ^/sitemap_index\.xml$ /index.php?sitemap=1 last;
        rewrite ^/([^/]+?)-sitemap([0-9]+)?.xml$ /index.php?sitemap=\$1&sitemap_n=\$2 last;
        # END Nginx Rewrites for Rank Math Sitemaps
    }

    location ~ ^/wp-json/ {
        rewrite ^/wp-json/(.*?)\$ /?rest_route=/$1 last;
    }

    location ~* /wp-sitemap.*\.xml {
        try_files \$uri \$uri/ /index.php\$is_args\$args;
    }

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    client_max_body_size 20M;

    location = /50x.html {
        root /usr/share/nginx/html;
    }

    location ~ \.php\$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
        include snippets/fastcgi-php.conf;
        fastcgi_buffers 1024 4k;
        fastcgi_buffer_size 128k;
    }

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 5;
    gzip_types application/json text/css application/x-javascript application/javascript image/svg+xml;
    gzip_proxied any;

    # Cache images, css, js, etc for 1 year
    location ~* \.(jpg|jpeg|gif|png|webp|svg|woff|woff2|ttf|css|js|ico|xml)\$ {
        access_log off;
        log_not_found off;
        expires 360d;
    }

    # Disable access to hidden files
    location ~ /\.ht {
        access_log off;
        log_not_found off;
        deny all;
    }
}
EOL

# Enable Nginx Configuration
ln -s /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
sudo systemctl restart nginx

# SSL Setup (Optional, Sertifikat SSL dapat ditambahkan jika diperlukan)
echo "=== Setting Up SSL ==="
mkdir -p $SSL_DIR
# Sertifikat SSL dapat di-generate menggunakan Let's Encrypt atau sertifikat lainnya.
# Sertifikat bisa ditambahkan secara manual di /etc/ssl/abgdiviral.wiki/cert.pem dan key.pem.

# Nginx SSL Configuration
cat > /etc/nginx/sites-available/$DOMAIN <<EOL
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.$DOMAIN $DOMAIN;

    ssl_certificate /etc/ssl/$DOMAIN/cert.pem;
    ssl_certificate_key /etc/ssl/$DOMAIN/key.pem;

    root $ROOT_DIR;
    index index.php index.html index.htm;

    # Same configurations as the non-SSL server block above
}
EOL

# Enable SSL site configuration
sudo ln -s /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
sudo systemctl restart nginx

# Set Permissions untuk WordPress
echo "=== Setting Permissions for WordPress ==="
sudo chown -R www-data:www-data $ROOT_DIR
chmod 755 $ROOT_DIR/wp-content

# Install WP-CLI
echo "=== Installing WP-CLI ==="
curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
chmod +x wp-cli.phar
mv wp-cli.phar /usr/local/bin/wp

# Konfigurasi WordPress
echo "=== Configuring WordPress ==="
sudo -u www-data wp core config --dbname=$DB_NAME --dbuser=$DB_USER --dbpass=$DB_PASS --path=$ROOT_DIR --skip-check

# Install dan Konfigurasi WordPress
echo "=== Installing WordPress ==="
sudo -u www-data wp core install --url="https://$DOMAIN" --title="Abgdiviral Wiki" --admin_user="admin" --admin_password="admin_password" --admin_email="admin@$DOMAIN" --path=$ROOT_DIR

# Install RankMath SEO Plugin
echo "=== Installing RankMath SEO Plugin ==="
sudo -u www-data wp plugin install rank-math --activate --path=$ROOT_DIR

# FastCGI Auto Purge Plugin for RankMath
echo "=== Setting Up FastCGI Auto Purge for RankMath ==="
WP_HOOK_FILE="$ROOT_DIR/wp-content/plugins/fastcgi-pro-auto-purge.php"
cat > $WP_HOOK_FILE <<EOL
<?php
/*
Plugin Name: FastCGI PRO Auto Purge
Description: Auto purge FastCGI cache on plugin/theme/content update and RankMath sitemap changes
*/
add_action('save_post', function(\$post_id){
    exec("rm -rf /etc/nginx/cache/*");
    // Cloudflare purge
    if (file_exists('/etc/cloudflare.env')) {
        \$token = trim(file_get_contents('/etc/cloudflare.env'));
        exec("curl -X POST 'https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache' -H 'Authorization: Bearer \$token' -H 'Content-Type: application/json' --data '{\"purge_everything\":true}'");
    }
});
add_action('upgrader_process_complete', function() {
    exec("rm -rf /etc/nginx/cache/*");
});
EOL
chown www-data:www-data $WP_HOOK_FILE

# Final Nginx Configuration untuk Pembatasan
echo "=== Configuring Nginx Global Limits ==="
cat > /etc/nginx/nginx.conf <<EOL
limit_req_zone \$binary_remote_addr zone=mylimit:10m rate=10r/s;
limit_conn_zone \$binary_remote_addr zone=addr:10m;
client_body_timeout   10s;
client_header_timeout 10s;
keepalive_timeout     10s;
send_timeout          10s;
EOL

# Reload Nginx
echo "=== Reloading Nginx ==="
sudo nginx -t
sudo systemctl restart nginx

# Cron Update WordPress
echo "=== Setting Up Automatic WordPress Update ==="
(crontab -l 2>/dev/null; echo "0 3 * * * wp core update --path=$ROOT_DIR && wp plugin update --all --path=$ROOT_DIR") | crontab -

echo "=== Installation Complete ==="
echo "WordPress has been successfully installed!"
echo "Domain: $DOMAIN"
echo "Database: $DB_NAME"
echo "Admin User: admin"
echo "Admin Password: admin_password"
