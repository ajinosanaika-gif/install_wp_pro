#!/bin/bash

# ==============================
# FUNCTIONS
# ==============================
# Function to install packages silently with progress bar
install_with_progress() {
    echo "Installing necessary packages..."
    sudo apt install -y "$@" &>/dev/null &
    progress_bar
    echo -e "\e[1;32mPackages installed successfully.\e[0m"
}

# Function to show progress bar for background processes
progress_bar() {
    local pid=$!
    local delay=0.1
    local spinstr='|/-\\'
    while kill -0 "$pid" 2>/dev/null; do
        for i in {1..10}; do
            printf " [%c]  " "$spinstr"
            spinstr=${spinstr#?}${spinstr%"${spinstr#?}"}
            sleep $delay
            printf "\b\b\b\b\b\b"
        done
    done
    echo " Done!"
}

progress_bar_bg() {
    local pid=$!
    local delay=0.1
    local spinstr='|/-\\'
    while kill -0 "$pid" 2>/dev/null; do
        for i in {1..10}; do
            printf " [%c]  " "$spinstr"
            spinstr=${spinstr#?}${spinstr%"${spinstr#?}"}
            sleep $delay
            printf "\b\b\b\b\b\b"
        done
    done
    echo " Done!"
}

# ==============================
# START SCRIPT
# ==============================
echo -e "\n\e[1;32mStarting WordPress Installation...\e[0m\n"

# Enable firewall & allow SSH
echo "Configuring UFW (Firewall)..."
ufw enable -y &>/dev/null
ufw allow ssh &>/dev/null

# Install Fail2Ban
install_with_progress fail2ban

# Enable and start Fail2Ban
sudo systemctl enable fail2ban &>/dev/null
sudo systemctl start fail2ban &>/dev/null

# Configure Fail2Ban for SSH
sudo tee /etc/fail2ban/jail.d/defaults-debian.conf &>/dev/null <<EOF
[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3
bantime = 600
findtime = 600
EOF

# Configure Fail2Ban for WordPress
sudo tee /etc/fail2ban/jail.d/wordpress.conf &>/dev/null <<EOF
[wordpress]
enabled = true
filter = wordpress
action = iptables[name=wordpress, port=http, protocol=tcp]
logpath = /var/www/*/wordpress/wp-content/debug.log
maxretry = 3
bantime = 600
findtime = 600
EOF

# Fail2Ban filter for WordPress
sudo tee /etc/fail2ban/filter.d/wordpress.conf &>/dev/null <<EOF
[Definition]
failregex = <HOST> -.*"(GET|POST).*wp-login.php
ignoreregex =
EOF

# Reload Fail2Ban
sudo systemctl reload fail2ban &>/dev/null

# Update packages
sudo apt update -y &>/dev/null

# Install core packages
install_with_progress nginx software-properties-common unzip mariadb-server mariadb-client

# Allow Nginx through firewall
ufw allow 'Nginx Full' &>/dev/null

# Add PHP repository
sudo add-apt-repository ppa:ondrej/php -y &>/dev/null
sudo apt update -y &>/dev/null

# Install PHP 8.4 + extensions
install_with_progress php8.4 php8.4-cli php8.4-fpm php8.4-common php8.4-dom php8.4-intl php8.4-mysql php8.4-xml php8.4-xmlrpc php8.4-curl php8.4-gd php8.4-imagick php8.4-dev php8.4-imap php8.4-mbstring php8.4-soap php8.4-zip php8.4-bcmath

# Set PHP 8.4 as default
sudo update-alternatives --set php /usr/bin/php8.4 &>/dev/null
sudo update-alternatives --set phpize /usr/bin/phpize8.4 &>/dev/null
sudo update-alternatives --set php-config /usr/bin/php-config8.4 &>/dev/null

php -v

# Prompt domain & database info
echo -e "\n\e[1;34mEnter your domain (e.g. example.com):\e[0m"
read domain
echo -e "\n\e[1;34mEnter the name of your database:\e[0m"
read dbname
echo -e "\n\e[1;34mEnter your database username:\e[0m"
read dbuser
echo -e "\n\e[1;34mEnter your database password:\e[0m"
read -s dbpass

# Create database & user
sudo mariadb <<EOF &>/dev/null
CREATE DATABASE ${dbname};
CREATE USER ${dbuser}@localhost IDENTIFIED BY '${dbpass}';
GRANT ALL PRIVILEGES ON ${dbname}.* TO ${dbuser}@localhost;
ALTER USER 'root'@'localhost' IDENTIFIED BY '${dbpass}';
FLUSH PRIVILEGES;
EXIT;
EOF

# Download WordPress
mkdir -p /var/www/${domain} &>/dev/null
cd /var/www/${domain}
wget -q https://wordpress.org/latest.zip -O wordpress.zip &>/dev/null
unzip -q wordpress.zip &>/dev/null
rm -f wordpress.zip &>/dev/null

# Nginx configuration
sudo tee /etc/nginx/sites-available/${domain} &>/dev/null <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name www.${domain} ${domain};
    return 301 https://${domain}\$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.${domain} ${domain};

    ssl_certificate         /etc/ssl/${domain}/cert.pem;
    ssl_certificate_key     /etc/ssl/${domain}/key.pem;
    ssl_protocols           TLSv1.2 TLSv1.3;
    ssl_ciphers             'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;

    root /var/www/${domain}/wordpress;
    index index.php index.html index.htm;

    error_log /var/log/nginx/${domain}-ssl.error;
    access_log /var/log/nginx/${domain}-ssl.access;

    location / {
        limit_req zone=mylimit burst=20 nodelay;
        limit_conn addr 10;
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF

# Enable site & SSL directory
sudo ln -s /etc/nginx/sites-available/${domain} /etc/nginx/sites-enabled/ &>/dev/null
mkdir -p /etc/ssl/${domain} &>/dev/null

# Prompt user to upload SSL
echo -e "\n\e[1;33mUpload your cert to /etc/ssl/${domain}/cert.pem and key to /etc/ssl/${domain}/key.pem\e[0m"
echo "Press any key to continue..."
read -n 1 -s -r

sudo nano /etc/ssl/${domain}/cert.pem
sudo nano /etc/ssl/${domain}/key.pem

# Generate DH param if not exists
sudo mkdir -p /etc/ssl/certs
if [ ! -f /etc/ssl/certs/dhparam.pem ]; then
    echo "Generating DH parameters (this may take a few minutes)..."
    sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048 &>/dev/null &
    progress_bar_bg
    sudo chmod 644 /etc/ssl/certs/dhparam.pem
    sudo chown root:root /etc/ssl/certs/dhparam.pem
fi

# Set permissions
sudo chown -R www-data:www-data /var/www/${domain}/wordpress/
sudo chmod 755 /var/www/${domain}/wordpress/wp-content

# Nginx rate limits & timeouts
if ! grep -q "limit_req_zone" /etc/nginx/nginx.conf; then
    sudo sed -i '/http {/a \ \ \ \ limit_req_zone \$binary_remote_addr zone=mylimit:10m rate=10r/s;' /etc/nginx/nginx.conf
    sudo sed -i '/http {/a \ \ \ \ limit_conn_zone \$binary_remote_addr zone=addr:10m;' /etc/nginx/nginx.conf
    sudo sed -i '/http {/a \ \ \ \ client_body_timeout 10s;' /etc/nginx/nginx.conf
    sudo sed -i '/http {/a \ \ \ \ client_header_timeout 10s;' /etc/nginx/nginx.conf
    sudo sed -i '/http {/a \ \ \ \ keepalive_timeout 10s;' /etc/nginx/nginx.conf
    sudo sed -i '/http {/a \ \ \ \ send_timeout 10s;' /etc/nginx/nginx.conf
fi

# Restart Nginx
sudo systemctl restart nginx &>/dev/null

# ==============================
# SUCCESS MESSAGE
# ==============================
echo -e "\n\e[1;34m--------------------------------------\e[0m"
echo -e "\n\e[1;32mWordPress installation for ${domain} completed successfully!\e[0m"
echo -e "\n\e[1;34m--------------------------------------\e[0m"
